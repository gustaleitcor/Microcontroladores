;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*              MODIFICAÃ‡Ã•ES PARA USO COM 12F675                   *
;*                FEITAS PELO PROF. MARDSON                        *
;*                      DEZEMBRO DE 2024                           *
;*                 BASEADO NO EXEMPLO DO LIVRO                     *
;*           Desbravando o PIC. David JosÃ© de Souza                *
;*-----------------------------------------------------------------*
;*   MODELO PARA O PIC 12F675                                      *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     ARQUIVOS DE DEFINIÃ‡Ã•ES                      *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
#INCLUDE <p12f675.inc>	;ARQUIVO PADRÃƒO MICROCHIP PARA 12F675

	__CONFIG _BODEN_OFF & _CP_OFF & _PWRTE_ON & _WDT_OFF & _MCLRE_ON & _INTRC_OSC_NOCLKOUT

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                    PAGINAÃ‡ÃƒO DE MEMÃ“RIA                         *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;DEFINIÃ‡ÃƒO DE COMANDOS DE USUÃRIO PARA ALTERAÃ‡ÃƒO DA PÃGINA DE MEMÃ“RIA
#DEFINE	BANK0	BCF STATUS,RP0	;SETA BANK 0 DE MEMÃ“RIA
#DEFINE	BANK1	BSF STATUS,RP0	;SETA BANK 1 DE MAMÃ“RIA

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                         VARIÃVEIS                               *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÃ‡ÃƒO DOS NOMES E ENDEREÃ‡OS DE TODAS AS VARIÃVEIS UTILIZADAS 
; PELO SISTEMA

	CBLOCK	0x20	;ENDEREÃ‡O INICIAL DA MEMÃ“RIA DE
					;USUÃRIO
		W_TEMP		;REGISTRADORES TEMPORÃRIOS PARA USO
		STATUS_TEMP	;JUNTO Ã€S INTERRUPÃ‡Ã•ES
		COUNTER
		COMPLEMENT

		;COLOQUE AQUI SUAS NOVAS VARIÃVEIS
		;NÃƒO ESQUEÃ‡A COMENTÃRIOS ESCLARECEDORES

	ENDC			;FIM DO BLOCO DE DEFINIÃ‡ÃƒO DE VARIÃVEIS

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                        FLAGS INTERNOS                           *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÃ‡ÃƒO DE TODOS OS FLAGS UTILIZADOS PELO SISTEMA

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                         CONSTANTES                              *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÃ‡ÃƒO DE TODAS AS CONSTANTES UTILIZADAS PELO SISTEMA

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                           ENTRADAS                              *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÃ‡ÃƒO DE TODOS OS PINOS QUE SERÃƒO UTILIZADOS COMO ENTRADA
; RECOMENDAMOS TAMBÃ‰M COMENTAR O SIGNIFICADO DE SEUS ESTADOS (0 E 1)

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                           SAÃDAS                                *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; DEFINIÃ‡ÃƒO DE TODOS OS PINOS QUE SERÃƒO UTILIZADOS COMO SAÃDA
; RECOMENDAMOS TAMBÃ‰M COMENTAR O SIGNIFICADO DE SEUS ESTADOS (0 E 1)

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                       VETOR DE RESET                            *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

	ORG	0x00			;ENDEREÃ‡O INICIAL DE PROCESSAMENTO
	GOTO	INICIO
	
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                    INÃCIO DA INTERRUPÃ‡ÃƒO                        *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; ENDEREÃ‡O DE DESVIO DAS INTERRUPÃ‡Ã•ES. A PRIMEIRA TAREFA Ã‰ SALVAR OS
; VALORES DE "W" E "STATUS" PARA RECUPERAÃ‡ÃƒO FUTURA

	ORG	0x04			;ENDEREÃ‡O INICIAL DA INTERRUPÃ‡ÃƒO
	BANK0
	MOVWF	W_TEMP		;COPIA W PARA W_TEMP
	SWAPF	STATUS,W
	MOVWF	STATUS_TEMP	;COPIA STATUS PARA STATUS_TEMP
	
	BCF     T1CON, TMR1ON	;Para TIMER1
	
	MOVLW   0xFF
	MOVWF   TMR1H		;Seta os 8 bits mais significativos do TIMER1
	
	MOVLW   0xF4
	MOVWF   TMR1L		;Seta os 8 bits menos significativos do TIMER1
	
	MOVLW	B'00111101'	;Configura o TIMER1
	MOVWF	T1CON
	
	BCF	PIR1,	TMR1IF	;Clear interrupção

	BSF     T1CON, TMR1ON	;Começa TIMER1

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                    ROTINA DE INTERRUPÃ‡ÃƒO                        *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; AQUI SERÃƒO ESCRITAS AS ROTINAS DE RECONHECIMENTO E TRATAMENTO DAS
; INTERRUPÃ‡Ã•ES

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                 ROTINA DE SAÃDA DA INTERRUPÃ‡ÃƒO                  *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; OS VALORES DE "W" E "STATUS" DEVEM SER RECUPERADOS ANTES DE 
; RETORNAR DA INTERRUPÃ‡ÃƒO

SAI_INT
	SWAPF	STATUS_TEMP,W
	MOVWF	STATUS		;MOVE STATUS_TEMP PARA STATUS
	SWAPF	W_TEMP,F
	SWAPF	W_TEMP,W	;MOVE W_TEMP PARA W
	

	
	RETFIE

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*	            	 ROTINAS E SUBROTINAS                      *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
; CADA ROTINA OU SUBROTINA DEVE POSSUIR A DESCRIÃ‡ÃƒO DE FUNCIONAMENTO
; E UM NOME COERENTE Ã€S SUAS FUNÃ‡Ã•ES.

SUBROTINA1

	;CORPO DA ROTINA

	RETURN

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     INICIO DO PROGRAMA                          *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
	
INICIO
	BANK1			;ALTERA PARA O BANCO 1
	MOVLW	B'00000010'	;CONFIGURA TODAS AS PORTAS DO GPIO (PINOS)
	MOVWF	TRISIO		;COMO SAÃDAS
	MOVLW	B'00000010'
	MOVWF	ANSEL 		;DEFINE PORTAS COMO Digital I/O
	MOVLW	B'00000100'
	MOVWF	OPTION_REG	;DEFINE OPÃ‡Ã•ES DE OPERAÃ‡ÃƒO
	MOVLW	B'11000000'
	MOVWF	INTCON		;DEFINE OPÃ‡Ã•ES DE INTERRUPÃ‡Ã•ES
	MOVLW	B'00000001'
	MOVWF	PIE1		;DEFINE OPÃ‡Ã•ES DE INTERRUPÃ‡Ã•ES
	MOVLW	B'10000000'
	MOVWF	VRCON
	BANK0			;RETORNA PARA O BANCO
	MOVLW	B'00000100'
	MOVWF	CMCON		;DEFINE O MODO DE OPERAÃ‡ÃƒO DO COMPARADOR ANALÃ“GICO
	MOVLW	B'00111101'
	MOVWF	T1CON
	


;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     INICIALIZAÃ‡ÃƒO DAS VARIÃVEIS                 *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     ROTINA PRINCIPAL                            *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
	
; =================================================================
; Código para o PIC12F675 que ajusta o brilho de um LED (GP4) com base
; na tensão de entrada aplicada à porta GP1.
; O duty cycle varia de 0% a 100% conforme a tensão de GP1 varia de 0V a 3,5V.
; =================================================================

MAIN
    BCF		GPIO, GP4        ; Garante que o LED (GP4) inicie desligado.

; =================================================================
; CONFIGURAÇÃO DO COMPARADOR E INICIALIZAÇÃO DE VARIÁVEIS
; =================================================================
LOOP1_SETUP    
    MOVLW	B'10100000'	    ; Carrega a configuração inicial para VRCON (low range)
				    ; Define a tensão de referência do comparador.

    BANK1			    ; Muda para o banco 1 (onde está o VRCON).
    MOVWF	VRCON		    ; Armazena o valor carregado no registrador VRCON.
    BANK0			    ; Retorna ao banco 0.

    CLRF	COUNTER		    ; Zera a variável COUNTER que controla o duty cycle.

    MOVLW	B'00000001'	    ; Carrega o valor 1 no acumulador W.
				    ; Será usado para incrementar COUNTER.

; =================================================================
; PRIMEIRO LOOP DE AJUSTE DO DUTY CYCLE - (Ajuste progressivo do Duty Cycle)
; =================================================================
LOOP1
    BTFSC	CMCON, COUT	    ; Verifica se a saída do comparador (COUT) está em 1.
    GOTO	BLINK_LED	    ; Se sim, pula para a rotina de controle do LED. (VIN- > CVRef)

    ADDWF	COUNTER, 1	    ; Incrementa COUNTER.
    BTFSC	STATUS, DC	    ; Se o bit de "carry" do STATUS for 1 (overflow),
    GOTO	LOOP2_SETUP	    ; muda para o segundo estágio de ajuste.

    BANK1			    ; Muda para o banco 1.
    ADDWF	VRCON		    ; Atualiza VRCON para ajustar a referência de tensão.
    BANK0			    ; Retorna para o banco 0.

    GOTO	LOOP1		    ; Volta para continuar ajustando o duty cycle.

; =================================================================
; CONFIGURAÇÃO DO COMPARADOR
; =================================================================
LOOP2_SETUP
    MOVLW	B'10001101'	    ; Define uma nova configuração para VRCON (high range)

    BANK1
    MOVWF	VRCON		    ; Atualiza VRCON com o novo valor.
    BANK0

    MOVLW	B'00000001'	    ; Prepara o incremento para COUNTER.

; =================================================================
; SEGUNDO LOOP DE AJUSTE DO DUTY CYCLE - (Ajuste progressivo do Duty Cycle)
; =================================================================
LOOP2
    BTFSC	CMCON, COUT      ; Verifica se a saída do comparador (COUT) está em 1. (VIN- > CVRef)
    GOTO	BLINK_LED        ; Se sim, pula para a rotina do LED.

    ADDWF	COUNTER, 1       ; Incrementa COUNTER.
    BTFSC	STATUS, DC       ; Se ocorrer overflow, pula para acionar o LED.
    GOTO	BLINK_LED

    BANK1
    ADDWF	VRCON		 ; Atualiza VRCON para novo ajuste da referência de tensão.
    BANK0

    GOTO	LOOP2		 ; Continua ajustando até atingir a condição.

; =================================================================
; CONTROLE DO LED - ACENDER
; =================================================================
BLINK_LED
    MOVLW	B'00010010'	    ; Carrega um valor fixo para o registrador COMPLEMENT.
    MOVWF	COMPLEMENT	    ; COMPLEMENT será usado para controle de tempo.

    MOVLW	B'00000000'	    ; Carrega 0 no acumulador W.
    XORWF	COUNTER		    ; Verifica se COUNTER é 0.
    BTFSC	STATUS, Z	    ; Se COUNTER == 0, volta ao início.
    GOTO	MAIN

    BSF		GPIO, GP4	    ; Acende o LED (GP4).

; =================================================================
; ATRASO PARA O TEMPO LIGADO DO LED (DUTY CYCLE)
; =================================================================
SLEEP_LOOP_LED_ON
    DECF	COMPLEMENT	    ; Decrementa o registrador COMPLEMENT.
    MOVLW	B'00000000'	    ; Carrega 0 em W.
    XORWF	COMPLEMENT	    ; Verifica se COMPLEMENT chegou a 0.

    SLEEP			    ; Entra no modo de baixo consumo para controle do tempo.

    BTFSC	STATUS, Z	    ; Se COMPLEMENT zerou, volta ao início do loop.
    GOTO	LOOP1_SETUP

    DECFSZ	COUNTER		    ; Decrementa COUNTER, se não for zero, repete o loop.
    GOTO	SLEEP_LOOP_LED_ON

    BCF		GPIO, GP4	    ; Desliga o LED (GP4).

; =================================================================
; ATRASO PARA O TEMPO DESLIGADO DO LED
; =================================================================
SLEEP_LOOP_LED_OFF
    SLEEP			; Entra em modo de economia de energia.
    DECFSZ	COMPLEMENT      ; Decrementa COMPLEMENT até zerar.
    GOTO	SLEEP_LOOP_LED_OFF

    GOTO	LOOP1_SETUP      ; Reinicia o processo de ajuste do duty cycle.


;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                       FIM DO PROGRAMA                           *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

    END